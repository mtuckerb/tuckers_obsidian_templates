<%*
const { season, moduleNumber, weekNumber, course, courseId, discipline, dayOfWeek } = await tp.user.new_module(app, tp, "2025");
let title = courseId
if (moduleNumber && weekNumber) { title = `M${moduleNumber}/W${weekNumber}`}
else if (moduleNumber) { title = `M${moduleNumber}`	 } 
else if (weekNumber) { title = `W${weekNumber}`}
-%>
---
title: <% courseId %> <%title%> <%dayOfWeek%>
course_id: <% courseId %>
contentType: ModuleNote
module_number: <% moduleNumber %>
week_number: <%weekNumber%>
created: <% tp.date.now("YYYY-MM-DD[T]hh:mm:SSSSZZ") %>
class_day: <% dayOfWeek %>
excalidraw-plugin: parsed
icon: FarStar
iconColor: purple
cssclasses: 
 - whiteRed
 - whiteRed-rounded
 - table-wide
excalidraw-open-md: true
tags: 
  - education
  - excalidraw
  - University_of_Southern_Maine
  - <% courseId %>
  - <% moduleNumber %>
  - <% tp.date.now("YYYY/MM/DD") %>
  - USM/<% tp.date.now("YYYY") %>/Season/<% courseId.split() %>/<% title %>
  - <% discipline%>/<%courseId%>/<%title%>
  
---
# [[<%course%>]] -  <%title%> - <%dayOfWeek%>
# Due Dates

| Date | Assignment |
| ---- | ---------- |
|      |            |
|      |            |
|      |            |

```dataviewjs
 function deduplicateFirstTwoColumns(arr) {
	const seen = new Set();
	return arr.filter(entry => {
		const key = JSON.stringify([entry[0], entry[1]]);
		return !seen.has(key) && seen.add(key);
	});

}
const processDueDates = async ( dv, courseId, cutOff = []) => {
  const startDate =
    cutOff.length > 0
      ? moment(cutOff[0]).format("YYYY-MM-DD")
      : moment().subtract(1, "day").format("YYYY-MM-DD")
  const endDate = moment(cutOff[1]).format("YYYY-MM-DD")
  const pages = await await dv.pages(`${courseId}`)
    .filter((p) => p.file.name !== courseId && p.file.ext == "md")

  let allEntries = []

  for (const page of pages.values) {
    if (!page?.file?.path) { return }
      const content = await app.vault.cachedRead(app.vault.getFileByPath(page.file?.path))
	const regex = /# Due Dates([\s\S]*?)(?=\n#|$)/
	const matches = content?.match(regex)
	if (matches) {
	  const tableData = matches[1].trim()
	  const lines = tableData.split("\n").slice(1)
	  for (const line of lines) {
		let formattedDueDate
		const columns = line
		  .split("|")
		  .map((c) => c.trim())
		  .filter((c) => c)
		let [dueDate, assignment] = columns
		if (!Date.parse(dueDate) || assignment?.match(/âœ…/)) {
		  continue
		}
		assignment = assignment?.match(/[A-Z]{3}-[0-9]{3}/)
		  ? assignment
		  : `#${page.course_id} - ${assignment}`
		if (
		  moment(dueDate).isBetween(startDate, endDate) ||
		  cutOff.length == 0
		) {
		  const uniqueRow = !allEntries.some(
			(e) =>
			  e[0].match(moment(dueDate)?.format("YYYY-MM-DD")) &&
			  e[1] == assignment
		  )
		  if (assignment && uniqueRow) {
			if (moment(dueDate)?.isBefore(startDate)) {
			  continue
			} else if (moment(dueDate).isAfter(moment().subtract(1, "w"))) {
			  formattedDueDate = `<span class="due one_week">${moment(
				dueDate
			  )?.format("YYYY-MM-DD ddd")}</span>`
			} else if (moment(dueDate).isAfter(moment().subtract(2, "w"))) {
			  formattedDueDate = `<span class="due two_weeks">${moment(
				dueDate
			  )?.format("YYYY-MM-DD ddd")}</span>`
			} else {
			  formattedDueDate = moment(dueDate)?.format("YYYY-MM-DD ddd")
			}
			allEntries.push([
			  dueDate,
			  formattedDueDate,
			  assignment,
			  `[[${page?.file?.path}|${page?.file?.name}]]`,
			])
		  }
		}
	  }
	}
  }
  
  const table = dv.markdownTable(
          ["Due Date", "Task Description", "File"],
          deduplicateFirstTwoColumns(allEntries
            .sort((a, b) => moment(a[-1]) - moment(b[0]))
            .map((a) => [a[1], a[2], a[3]])
        ))
      dv.el("table", table)
}
processDueDates(dv,"#<%- courseId.toUpperCase() %>")
```


# Vocabulary


# Class Notes




---
%%
# Excalidraw Data
## Text Elements

## Element Links


## Embedded Files


## Drawing
```json
{"type":"excalidraw","version":2,"source":"https://github.com/zsviczian/obsidian-excalidraw-plugin/releases/tag/2.8.0","elements":[],"appState":{"gridSize":null,"viewBackgroundColor":"#ffffff"}}
```
%%